generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int                @id @default(autoincrement())
  email             String             @unique
  password          String
  name              String?
  phone             String?
  role              Role               @default(CUSTOMER)
  avatar            String?
  createdAt         DateTime           @default(now())
  addresses         Address[]
  cart              Cart?
  chatConversations ChatConversation[]
  chatSessions      ChatSession[]
  orders            Order[]
  reviews           Review[]
  supportMessages   SupportMessage[]
  userPayments      UserPayment[]
  claimedVouchers   UserVoucher[]
  favorites         ProductVariant[]   @relation("UserFavorites")
}

model PaymentMethod {
  id           Int           @id @default(autoincrement())
  name         String
  code         String        @unique
  description  String?
  image        String?
  isActive     Boolean       @default(true)
  savedInUsers UserPayment[]
}

model UserPayment {
  id              Int           @id @default(autoincrement())
  userId          Int
  paymentMethodId Int
  provider        String?
  accountNumber   String
  expiryDate      String?
  isDefault       Boolean       @default(false)
  createdAt       DateTime      @default(now())
  paymentMethod   PaymentMethod @relation(fields: [paymentMethodId], references: [id])
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Address {
  id            Int     @id @default(autoincrement())
  userId        Int
  recipientName String
  phone         String
  city          String
  district      String?
  ward          String?
  detail        String
  isDefault     Boolean @default(false)
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Category {
  id       Int        @id @default(autoincrement())
  name     String
  slug     String     @unique
  image    String?
  parentId Int?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]  @relation("CategoryToProduct")
}

model Product {
  id              Int              @id @default(autoincrement())
  name            String
  slug            String           @unique
  description     String?
  thumbnail       String?
  originalPrice   Decimal          @db.Decimal(10, 2)
  price           Decimal          @db.Decimal(10, 2)
  isActive        Boolean          @default(true)
  rating          Float            @default(0)
  reviewCount     Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  messageProducts MessageProduct[]
  variants        ProductVariant[]
  reviews         Review[]
  categories      Category[]       @relation("CategoryToProduct")
}

model ProductVariant {
  id          Int         @id @default(autoincrement())
  productId   Int
  color       String
  size        String
  sku         String?     @unique
  image       String?
  stock       Int         @default(0)
  cartItems   CartItem[]
  orderItems  OrderItem[]
  product     Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  favoritedBy User[]      @relation("UserFavorites")

  @@unique([productId, color, size])
}

model Cart {
  id        Int        @id @default(autoincrement())
  userId    Int        @unique
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  cartItems CartItem[]
}

model CartItem {
  id        Int            @id @default(autoincrement())
  cartId    Int
  variantId Int
  quantity  Int
  cart      Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([cartId, variantId])
}

model Order {
  id              Int         @id @default(autoincrement())
  userId          Int
  shippingAddress String
  paymentMethod   String
  voucherId       Int?
  status          OrderStatus @default(PENDING)
  totalAmount     Decimal     @db.Decimal(10, 2)
  shippingFee     Decimal     @default(0) @db.Decimal(10, 2)
  discountAmount  Decimal     @default(0) @db.Decimal(10, 2)
  finalAmount     Decimal     @db.Decimal(10, 2)
  paymentStatus   String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  user            User        @relation(fields: [userId], references: [id])
  voucher         Voucher?    @relation(fields: [voucherId], references: [id])
  orderItems      OrderItem[]
}

model OrderItem {
  id        Int            @id @default(autoincrement())
  orderId   Int
  variantId Int
  quantity  Int
  price     Decimal        @db.Decimal(10, 2)
  order     Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  @@unique([orderId, variantId])
}

model Voucher {
  id          Int           @id @default(autoincrement())
  code        String        @unique
  value       Decimal       @db.Decimal(10, 2)
  type        String        @default("FIXED")
  stock       Int           @default(0)
  usedCount   Int           @default(0)
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean       @default(true)
  description String?
  orders      Order[]
  claimers    UserVoucher[]
}

model UserVoucher {
  id        Int      @id @default(autoincrement())
  userId    Int
  voucherId Int
  isUsed    Boolean  @default(false)
  claimedAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  voucher   Voucher  @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  @@unique([userId, voucherId])
}

model Review {
  id        Int      @id @default(autoincrement())
  userId    Int
  productId Int
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model SupportMessage {
  id        Int      @id @default(autoincrement())
  userId    Int
  content   String
  status    String   @default("OPEN")
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model ChatConversation {
  id          Int           @id @default(autoincrement())
  userId      Int
  status      ChatStatus    @default(OPEN)
  unreadCount Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User          @relation(fields: [userId], references: [id])
  messages    ChatMessage[]
}

model ChatMessage {
  id             Int              @id @default(autoincrement())
  conversationId Int
  sender         MessageSender
  content        String
  isRead         Boolean          @default(false)
  createdAt      DateTime         @default(now())
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model Banner {
  id        Int      @id @default(autoincrement())
  title     String
  subtitle  String?
  imageUrl  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ChatSession {
  id        Int              @id @default(autoincrement())
  userId    Int?
  title     String           @default("New Chat")
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  messages  ChatBotMessage[]
  user      User?            @relation(fields: [userId], references: [id])
}

model ChatBotMessage {
  id        BigInt           @id @default(autoincrement())
  sessionId Int
  role      ChatRole
  content   String
  createdAt DateTime         @default(now())
  session   ChatSession      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  products  MessageProduct[]
}

model MessageProduct {
  id        Int            @id @default(autoincrement())
  messageId BigInt
  productId Int
  message   ChatBotMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  product   Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
}

enum Role {
  CUSTOMER
  ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPING
  COMPLETED
  CANCELLED
  RETURNED
}

enum ChatStatus {
  OPEN
  CLOSED
  PENDING
}

enum MessageSender {
  CUSTOMER
  ADMIN
}

enum ChatRole {
  USER
  BOT
}
